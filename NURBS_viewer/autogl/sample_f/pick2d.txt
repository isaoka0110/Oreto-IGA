                サンプルプログラムpick2dの解説

目次

1. 概要
2. プログラムの動作について
3. ソースコードの解説

このサンプルプログラムのポイント

* 二次元イベント処理
* 二次元の点をピックする方法

このサンプルプログラムで紹介されている「おてがる」コールバックサブルーチン

autogl_handle_event
  「おてがる」のイベント処理コールバックサブルーチン。
  ユーザープログラム側にこの名前で必ず一つだけ存在しなければならない。

このサンプルプログラムで紹介されている「おてがる」API

autogl_draw_diamond_mark2d
  ダイアモンドマークを描画する。
autogl_get_view_event
  イベントの種類を調べる。
autogl_pointing_device_is_hit2d
  指定のワールド座標のそばでマウスピックがおきたかどうかを調べる。
autogl_draw_view
  再描画コールバックを強制的にコールする。
autogl_handle_default_key_event_in_mode2d
  二次元アプリケーション用にデフォルトキーボードイベント処理を行なう。
autogl_set_default_callback_in_mode2d
  ビューウィンドウのイベント処理を二次元アプリケーション用に指定する。
autogl_set_mode2d
  ビューウィンドウの初期状態でのモードを設定する。



1. 概要

サンプルプログラムpick2dでは、「おてがる」二次元ユーティリティの
二次元イベント処理機能を紹介しています。

「おてがる」二次元ユーティリティは、二次元アプリケーションのための
一般的なユーティリティ機能を実装しています。
このサンプルプログラムは、このうち、二次元アプリケーション用の
マウスやキーボードからのイベント処理について説明しています。

詳しくは、マニュアルのAPIリファレンスmanual/api_reference.txtのうち、
二次元ユーティリティのセクションを御覧下さい。

また、ビューでのイベント処理一般については、以下も関係します。
マニュアルのAPIリファレンスmanual/api_reference.txtのうち、
グラフィックスにおけるイベント処理セクションを御覧下さい。



2. プログラムの動作について

このプログラムは、起動すると二次元のオブジェクトを表示します。

画面には、５本の線分から構成されるポリラインが表示されており、
さらにその６つの頂点には、赤いダイヤモンドのマークがついています。

ここで、その赤いマークのどれかをマウスの左ボタンでクリックしてみましょう。
それが選択されてダイアモンドが塗りつぶされ、
一方、端末にはメッセージが表示されます。
メッセージから、選択された頂点の番号(１から開始される)が分かります。
別のマークを選択すれば、これまで選択されていたものはクリアされます。
その他の部分を選択しようとすれば、すべての選択が解除されます。

また、このサンプルプログラムは二次元アプリケーションなので、
メニューバーからPanelを表示し、移動や拡大縮小ができます。
modeチョイスのモードをその他(Other)にすると、
マウスによる頂点の選択ができるようになります。



3. ソースコードの解説

ソースコードpick2d.fを上から眺めていきます。

まず、メインルーチンです。

コモンブロックですが、
最初の変数vertexsはポリラインを構成する各頂点の二次元座標を表します。

次の変数selected_vertex_idは、
現在選択されている頂点の番号を記録しています。
選択されていれば、1から6までの整数のどれかをとり、
また、なにも選択されていなければ、-1となります。

「おてがる」APIのautogl_set_default_callback_in_mode2dにより、
イベント処理を二次元アプリケーション向けに設定し、
マウスによる移動や拡大縮小ができるようにします。

「おてがる」APIのautogl_set_mode2dにより、
初期状態でのモードをその他(Other = 0)にしています。

ちなみに、二次元アプリケーション設定では、
ビュー上でキーボード入力すると以下のようにモードが切りかわります。

Oまたはoキー : Other      その他     0
Tまたはtキー : Translate  移動       1
Sまたはsキー : Scale      拡大縮小   2

そろそろモード切替えのマウス操作がウザくなってきたころでしょうから、
活用してみてください。

再描画コールバックautogl_redrawでは、二次元平面の座標軸を描画し、
続いてポリラインを描画します。
さらに、doループで各頂点をまわり、
autogl_draw_diamond_mark2dという「おてがる」APIにより
ダイアモンドマークを描画します。
これは、二次元ユーティリティのひとつです。
ここで、もしその頂点が選択されていれば、マークを塗りつぶします。

このあと出てくるサブルーチンautogl_handle_eventは、
イベント処理のためのコールバックです。
このサンプルプログラムにおいてイベント処理コールバックautogl_handle_eventは、
ビューへのマウスやキーボードアクションが生じるたびにコールされます。

ここでは、まず、autogl_get_view_eventコールによりイベントの種類を得ています。
以下のようなイベントがあります。

0 : マウスボタンが押された。
1 : マウスがドラッグされた。
2 : マウスボタンが離された。
3 : キーボードのキーが押された。

マウスクリックに対応してなにかしたいのなら、
ポインティングデバイスであるマウスのボタンがリリースしたタイミングで、
このコールバックの中でそれを行います。
このサンプルプログラムでは、どれかの頂点のそばでマウスクリックがあったか
どうかを調べます。
もしあれば、その頂点を選択し、
選択したタイミングで端末にメッセージを表示します。
一方、なにも選択されなければ、selected_vertex_idには-1が入っているはずです。

ここで、「おてがる」APIのautogl_pointing_device_is_hit2dは、
指定した座標のそばでマウスイベントが起きたかどうかをチェックします。
引数は、ワールド座標系におけるx、y座標、および、
ピックのトレランスをデバイス座標系でのピクセル数で指定します。

なんにせよ、なんらかの変化があれば、ビューを再描画するため、
autogl_draw_viewをコールします。

あと、なんらかのキーボードイベントが生じたときには、
「おてがる」二次元アプリケーションとしてのデフォルト処理
autogl_handle_default_key_event_in_mode2dを実行します。

