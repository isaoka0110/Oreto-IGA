                サンプルプログラムpick3dの解説

目次

1. 概要
2. プログラムの動作について
3. ソースコードの解説

このサンプルプログラムのポイント

* 三次元イベント処理
* 三次元の点をピックする方法

このサンプルプログラムで紹介されている「おてがる」API

AutoGL_DrawDiamondMark3D
  ダイアモンドマークを描画する。
AutoGL_GetViewEvent
  イベントの種類を調べる。
AutoGL_PointingDeviceIsHit3D
  指定のワールド座標のそばでマウスピックがおきたかどうかを調べる。
AutoGL_DrawView
  再描画コールバックを強制的にコールする。
AutoGL_HandleDefaultKeyEventInMode3D
  三次元アプリケーション用にデフォルトキーボードイベント処理を行なう。
AutoGL_SetDefaultCallbackInMode3D
  ビューウィンドウのイベント処理を三次元アプリケーション用に指定する。
  また、Otherモードでのイベント処理コールバック関数を指定する。
AutoGL_SetMode3D
  ビューウィンドウの初期状態でのモードを設定する。



1. 概要

サンプルプログラムpick3dでは、「おてがる」三次元ユーティリティの
三次元イベント処理機能を紹介しています。

「おてがる」三次元ユーティリティは、三次元アプリケーションのための
一般的なユーティリティ機能を実装しています。
このサンプルプログラムは、このうち、三次元アプリケーション用の
マウスやキーボードからのイベント処理について説明しています。

詳しくは、マニュアルのAPIリファレンスmanual/api_reference.txtのうち、
三次元ユーティリティのセクションか、
または、「おてがる」ヘッダファイルautogl.hよりインクルードされている、
lib/autogl_utility3d.hを御覧下さい。

また、ビューでのイベント処理一般については、以下も関係します。
マニュアルのAPIリファレンスmanual/api_reference.txtのうち、
グラフィックスのセクションか、
または、「おてがる」ヘッダファイルautogl.hよりインクルードされている、
lib/autogl_graphics.hを御覧下さい。



2. プログラムの動作について

このプログラムは、起動すると三次元のオブジェクトを表示します。

画面には、直方体が表示されており、
さらにその８つの頂点には、赤いダイヤモンドのマークがついています。

ここで、その赤いマークのどれかをマウスの左ボタンでクリックしてみましょう。
それが選択されてダイアモンドが塗りつぶされ、
一方、端末にはメッセージが表示されます。
メッセージから、選択された頂点の番号(０から開始される)が分かります。
別のマークを選択すれば、これまで選択されていたものはクリアされます。
その他の部分を選択しようとすれば、すべての選択が解除されます。

また、このサンプルプログラムは三次元アプリケーションなので、
メニューバーからPanelを表示し、移動や回転、拡大縮小ができます。
modeチョイスのモードをその他(Other)にすると、
マウスによる頂点の選択ができるようになります。



3. ソースコードの解説

ソースコードpick3d.cを上から眺めていきます。

「おてがる」のヘッダファイルを読み込んだあと、
いくつかのグローバル変数が登場します。

最初の変数SelectedVertexIdは、
現在選択されている頂点の番号を記録しています。
選択されていれば、0から7までの整数のどれかをとり、
また、なにも選択されていなければ、-1となります。

次の変数Vertexsは直方体を構成する各頂点の三次元座標を表します。

再描画コールバックRedrawViewでは、三次元空間の座標軸を描画し、
続いて直方体を描画します。
さらに、forループで各頂点をまわり、
AutoGL_DrawDiamondMark3Dという「おてがる」APIにより
ダイアモンドマークを描画します。
これは、三次元ユーティリティのひとつです。
ここで、もしその頂点が選択されていれば、マークを塗りつぶします。

このあと出てくる関数HandleEventは、イベント処理のためのコールバックです。
このサンプルプログラムにおいてイベント処理コールバックHandleEventは、
ビューへのマウスやキーボードアクションが生じるたびにコールされます。

ここでは、まず、AutoGL_GetViewEventコールによりイベントの種類を得ています。
以下のようなイベントがあります。

AUTOGL_EVENT_POINTING_DEVICE_PRESS : マウスボタンが押された。
AUTOGL_EVENT_POINTING_DEVICE_DRAG : マウスがドラッグされた。
AUTOGL_EVENT_POINTING_DEVICE_RELEASE : マウスボタンが離された。
AUTOGL_EVENT_KEY : キーボードのキーが押された。

マウスクリックに対応してなにかしたいのなら、
ポインティングデバイスであるマウスのボタンがリリースしたタイミングで、
このコールバックの中でそれを行います。
このサンプルプログラムでは、どれかの頂点のそばでマウスクリックがあったか
どうかを調べます。
もしあれば、その頂点を選択し、
選択したタイミングで端末にメッセージを表示します。
一方、なにも選択されなければ、SelectedVertexIdには-1が入っているはずです。

ここで、「おてがる」APIのAutoGL_PointingDeviceIsHit3Dは、
指定した座標のそばでマウスイベントが起きたかどうかをチェックします。
引数は、深さ情報をあらわすパラメータをdoubleポインタとして、
ワールド座標系におけるx、y、z座標、
および、ピックのトレランスをデバイス座標系でのピクセル数で指定します。
なお、一番目のパラメータは今回は使いません。

なんにせよ、なんらかの変化があれば、ビューを再描画するため、
AutoGL_DrawViewをコールします。

あと、なんらかのキーボードイベントが生じたときには、
「おてがる」三次元アプリケーションとしてのデフォルト処理
AutoGL_HandleDefaultKeyEventInMode3Dを実行します。

最後に、初期化コールバックAutoGL_SetUpでは、
「おてがる」APIのAutoGL_SetDefaultCallbackInMode3Dをコールしています。
これは、イベント処理を三次元アプリケーション向けに設定し、
マウスによる移動や拡大縮小ができるようにします。
ここで、モードがその他(Other)のときに生じるイベントを処理するため、
関数HandleEventをイベント処理コールバックに指定しています。
イベント処理のコールバックはvoid function (void)形式でなければなりません。

あと、「おてがる」APIのAutoGL_SetMode3Dにより、
初期状態でのモードをその他(Other)にしています。

ちなみに、三次元アプリケーション設定では、
ビュー上でキーボード入力すると以下のようにモードが切りかわります。

Oまたはoキー : Other             その他        0
Tまたはtキー : Translate         移動          1
Rまたはrキー : Rotate            回転          2
Uまたはuキー : rotate Up vector  上方向の回転  3
Sまたはsキー : Scale             拡大縮小      4

そろそろモード切替えのマウス操作がウザくなってきたころでしょうから、
活用してみてください。
